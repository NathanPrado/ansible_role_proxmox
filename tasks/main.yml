---
# tasks file for engonzal.proxmox
- name: Provision ct {{ pve_hostname }}
  proxmox:
    vmid: "{{ pve_vmid | default(omit) }}"
    node: "{{ pve_node | default(omit) }}"
    api_user: "{{ pve_apiuser }}"
    api_password: "{{ pve_apipass}}"
    api_host: "{{ pve_api_host }}"
    state: "{{ pve_state | default('present') }}"
    hostname: "{{ pve_hostname | default(omit)}}"
    ostemplate: "{{ pve_template | default (omit) }}"
    mounts: "{{ pve_mounts | default(omit) }}"
    netif: "{{ pve_netif | default(omit) }}"
    cores: "{{ pve_cores | default(omit) }}"
    memory: "{{ pve_mem | default(omit) }}"
    swap: "{{ pve_swap | default(omit) }}"
    password: "{{ pve_guest_pass | default(omit) }}"
    searchdomain: "{{ pve_search | default(omit) }}"
    nameserver: "{{ pve_dns | default(omit) }}"
    storage: "{{ pve_storage | default(omit)}}"
    unprivileged: "{{ pve_unprivileged | default(omit)}}"
    pubkey: "{{ pve_ssh | default(omit) }}"
    onboot: "{{ pve_onboot | default(omit) }}"
  register: pve_info
  delegate_to: localhost
  async: 45
  poll: 5

- name: Set vmid var
  set_fact:
    pve_new_vmid:  "{{ pve_info.msg.split(' ')[2] }}"
  when: pve_info.failed | bool == false

- name: Get CT{{ pve_vmid | default(pve_new_vmid) }} config
  command: pct config {{ pve_vmid | default (pve_new_vmid)}}
  register: pve_info_mounts
  delegate_to: "{{ pve_node }}"
  changed_when: false

- name: Manually add bind mounts to CT{{ pve_vmid | default(pve_new_vmid) }}
  command: "pct set {{ pve_vmid | default(pve_new_vmid) }} -{{ item.key }} {{ item.value }}"
  loop: "{{ pve_custom_mounts | default({})|dict2items }}"
  when:
    - pve_custom_mounts is defined
    - pve_info.failed | bool == false
    - item.key not in pve_info_mounts.stdout
  delegate_to: "{{ pve_node }}"

- name: Start CT{{ pve_vmid | default(pve_new_vmid) }}
  proxmox:
    vmid: "{{ pve_vmid | default(pve_new_vmid) | int }}"
    api_user: "{{ pve_apiuser }}"
    api_password: "{{ pve_apipass}}"
    api_host: "{{ pve_api_host }}"
    state: started
  delegate_to: localhost
  register: pve_info_state
